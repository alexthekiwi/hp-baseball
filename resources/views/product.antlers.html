{{ nocache }}
{{ partial:main :hero_bg_type="'Colour'" :hero_bg_colour="'white'" }}
    {{ if is_bundle }}
    <div x-data="productPage()"
          data-is-bundle="true"
          data-bundle-items='{{ bundle_items | to_json }}'
          data-price="{{ price ?? 0 }}">
    {{ elseif product_variants }}
    <div x-data="productPage()"
          data-first-variant="{{ product_variants:options limit='1' }}{{ key }}{{ /product_variants:options }}"
          data-first-price="{{ product_variants:options limit='1' }}{{ price }}{{ /product_variants:options }}">
    {{ else }}
    <div x-data="productPage()"
          data-price="{{ price ?? 0 }}">
    {{ /if }}
        {{ partial:components/blocks/_hero
            :title="title"
            background_type="Colour"
            background_colour="primary"
            align="start"
            show_breadcrumbs="true"
        }}

        {{ partial:components/block
            padding_top="none"
            padding_bottom="base"
        }}

            <!-- Success Message -->
            <div x-cloak x-show="showSuccessMessage" x-transition.opacity.duration.500ms
                 class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg"
                 x-init="setTimeout(() => showSuccessMessage = false, 5000)">
                Product added to cart successfully!
            </div>

            <!-- Already in Cart Message -->
            {{ if {cart:added product="{page:id}"} }}
                <div class="flex gap-6 items-start flex-col md:items-center md:flex-row md:justify-between p-6 bg-gray-light text-primary rounded-lg">
                    <span class="font-bold">This product is in your cart.</span>
                    {{ partial:components/common/button link="/cart" colour="primary" style="Solid" }}
                        Go to Cart
                    {{ /partial:components/common/button }}
                </div>
            {{ /if }}

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-y-8 gap-x-16">
                <div class="space-y-4">
                    {{ partial:alpine/carousel }}
                </div>

                <div class="flex flex-col gap-6">
                    <!-- Details -->
                    <div class="space-y-4">
                        <h3 class="font-semibold">Details</h3>
                        <div class="text-base prose">
                            {{ content }}
                        </div>
                    </div>

                    {{ if settings:shop_enabled }}
                        <!-- Add to Cart Form -->
                        {{ cart:add class="space-y-6" @submit.prevent="handleAddToCart($event)" }}
                        <input type="hidden" name="product" value="{{ page:id }}">

                        <!-- Bundle Size Selectors -->
                        {{ if is_bundle }}
                            <!-- Hidden variant input for bundles -->
                            <input type="hidden" name="variant" value="custom">
                            
                            <div class="space-y-6">
                                <h3 class="font-semibold">Select size for each item:</h3>
                                {{ bundle_items scope="item" }}
                                    <div class="p-4 border border-gray-200 rounded-lg">
                                        <h4 class="font-medium mb-2">{{ item:name }}</h4>
                                        <p class="text-sm text-gray-600 mb-3">{{ item:description }}</p>
                                        <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                                            {{ available_sizes }}
                                                <label class="relative">
                                                    <input
                                                        type="radio"
                                                        name="bundle_size_{{ item:name | slugify }}"
                                                        value="{{ value }}"
                                                        x-model="bundleSizes['{{ item:name }}']"
                                                        required
                                                        class="sr-only peer"
                                                    >
                                                    <div class="text-center px-3 py-2 text-sm border border-gray-300 rounded-lg cursor-pointer hover:border-primary peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white transition-all">
                                                        {{ value }}
                                                    </div>
                                                </label>
                                            {{ /available_sizes }}
                                        </div>
                                    </div>
                                {{ /bundle_items }}
                                
                                <!-- Store bundle configuration for display -->
                                <div class="mt-4 p-3 bg-gray-50 rounded text-sm" x-show="canAddToCart()">
                                    <p class="font-semibold mb-1">Your Selection:</p>
                                    <template x-for="(size, item) in bundleSizes" :key="item">
                                        <p class="text-gray-600">
                                            <span x-text="item"></span>: <span class="font-medium" x-text="size"></span>
                                        </p>
                                    </template>
                                </div>
                            </div>
                        <!-- Regular Variant Selector -->
                        {{ elseif product_variants }}
                            <div>
                                <label class="block text-sm font-medium mb-3">Size</label>
                                <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                                    {{ product_variants:options }}
                                        <label class="relative">
                                            <input
                                                type="radio"
                                                name="variant"
                                                value="{{ key }}"
                                                x-model="selectedVariant"
                                                @change="updatePriceFromString('{{ price }}')"
                                                {{ if first }}checked{{ /if }}
                                                required
                                                class="sr-only peer"
                                            >
                                            <div class="text-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:border-primary peer-checked:border-primary peer-checked:bg-primary peer-checked:text-white transition-all">
                                                {{ variant }}
                                            </div>
                                        </label>
                                    {{ /product_variants:options }}
                                </div>
                            </div>
                        {{ /if }}

                        <!-- Price Display -->
                        <div class="text-2xl font-bold text-primary">
                            {{ if is_bundle }}
                                {{ price }}
                            {{ elseif product_variants }}
                                <div x-show="selectedPrice" x-text="'$' + (selectedPrice / 100).toFixed(2)"></div>
                            {{ else }}
                                {{ price }}
                            {{ /if }}
                        </div>

                        <!-- Quantity Selector -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Quantity</label>
                            <input
                                type="number"
                                name="quantity"
                                min="1"
                                value="1"
                                required
                                class="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                        </div>

                        <!-- Add to Cart Button -->
                        <button
                            type="submit"
                            :disabled="isSubmitting || (isBundle && !canAddToCart())"
                            class="bg-primary px-8 py-3 text-white font-medium rounded-lg transition-colors hover:bg-primary-dark disabled:opacity-50">
                            <span x-text="isSubmitting ? 'Adding...' : 'Add to Cart'"></span>
                        </button>
                    {{ /cart:add }}
                    {{ else }}
                        <p class="font-bold text-primary">The shop has currently closed for the season.<br/>Please check back another time.</p>
                    {{ /if }}
                </div>
            </div>
        {{ /partial:components/block }}
    </div>
{{ /partial:main }}
{{ /nocache }}
